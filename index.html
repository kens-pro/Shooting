<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8" />
  <!-- Google tag (gtag.js) -->
<script async src="https://www.googletagmanager.com/gtag/js?id=G-CYDY7MGN3Y"></script>
<script>
  window.dataLayer = window.dataLayer || [];
  function gtag(){dataLayer.push(arguments);}
  gtag('js', new Date());

  gtag('config', 'G-CYDY7MGN3Y');
</script>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>音感＆読譜シューティング</title>
  <style>
    :root{ --bg:#0b1020; --ink:#e6f0ff; --accent:#66d9ef; --danger:#ff6b6b; --muted:#90a4ae; }
    html,body{height:100%;margin:0;background:radial-gradient(1200px 800px at 50% 20%, #141c39 0%, #0b1020 60%, #05070f 100%);color:var(--ink);font-family: system-ui, -apple-system, Segoe UI, Roboto, "Hiragino Kaku Gothic ProN", Meiryo, sans-serif}
    .wrap{position:relative;height:100%}
    canvas#game{ position:absolute; inset:0; width:100%; height:100%; display:block; z-index:0; }
    /* 祝福用: 前面に重ねる花火キャンバス */
    canvas#celebrateFx{ position:absolute; inset:0; width:100%; height:100%; display:none; z-index:7; pointer-events:none; }

    .hud{position:absolute;top:12px;left:12px;right:12px;display:flex;gap:8px;justify-content:space-between;font-weight:600;letter-spacing:.5px;text-shadow:0 1px 2px rgba(0,0,0,.6); z-index:6;}
    .badge{background:rgba(255,255,255,.06);border:1px solid rgba(255,255,255,.1);padding:8px 12px;border-radius:14px;box-shadow:0 4px 16px rgba(0,0,0,.25)}
    .overlay{position:absolute;inset:0;display:grid;place-items:center;background:linear-gradient(180deg, rgba(6,10,22,.8), rgba(6,10,22,.6));backdrop-filter: blur(4px); z-index:5;}
    .panel{max-width:min(760px,92vw);text-align:center;padding:28px 24px;border-radius:18px;border:1px solid rgba(255,255,255,.12);background:rgba(15,20,35,.55);box-shadow:0 12px 40px rgba(0,0,0,.35)}
    h1{font-size:28px;margin:0 0 12px}
    .desc{color:#c9d6ff;line-height:1.7;font-size:14px}
    .keys{display:grid;grid-template-columns:1fr;gap:6px;margin:14px 0 18px}
    .keys span{display:inline-block;background:rgba(255,255,255,.07);border:1px solid rgba(255,255,255,.16);padding:8px 12px;border-radius:12px}
    .btn{appearance:none;border:none;background:linear-gradient(180deg,#2a9dff,#2576ff);color:white;padding:12px 20px;font-weight:700;border-radius:12px;cursor:pointer;box-shadow:0 10px 24px rgba(37,118,255,.35)}
    .btn:active{transform:translateY(1px)}
    .muted{color:var(--muted);font-size:12px}
    .btn.high{background:linear-gradient(180deg,#ff7ad9,#ff3fbf)}
    .btn.low {background:linear-gradient(180deg,#2a9dff,#2576ff)}
    .mobile-controls{position:absolute;left:0;right:0;bottom:14px;display:none;justify-content:center;gap:12px;pointer-events:auto; z-index:6}
    .mc-btn{min-width:64px;height:64px;border-radius:18px;border:1px solid rgba(255,255,255,.15);background:rgba(255,255,255,.06);color:var(--ink);font-size:22px;font-weight:800;box-shadow:0 8px 20px rgba(0,0,0,.35)}
    .mc-btn:active{transform:translateY(1px)}
    @media (max-width:820px){.mobile-controls{display:flex}}

    /* クイズUI */
    #quiz{ z-index: 9999; pointer-events: auto; }
    #quiz, #quiz * { pointer-events: auto; }
    .quiz-cards{ display:flex; gap:14px; justify-content:center; flex-wrap:wrap; margin-top:12px }
    .quiz-card{
      width:200px; height:120px; border-radius:14px;
      background:rgba(255,255,255,.05);
      border:1px solid rgba(255,255,255,.14);
      box-shadow:0 6px 18px rgba(0,0,0,.28);
      transition: transform .08s ease, box-shadow .08s ease, border-color .08s ease;
      cursor:pointer;
      touch-action:manipulation;
    }
    .quiz-card:hover{ transform:translateY(-2px); box-shadow:0 10px 24px rgba(0,0,0,.34); border-color:rgba(255,255,255,.28) }
    .quiz-card:active{ transform:translateY(0) scale(.99) }
    .quiz-choices{ display:flex; gap:12px; justify-content:center; flex-wrap:wrap; margin-top:8px }

/* 祝福オーバーレイ（きらめき・虹色テキスト） */
#finaleGlow{
  position:absolute; inset:0;
  z-index:10;                /* 8 → 10 に上げる(任意) */
  display:none; place-items:center;
  background: radial-gradient(900px 600px at 50% 30%,
              rgba(255,255,255,.12), rgba(0,0,0,.45) 50%, rgba(0,0,0,.6) 100%);
  pointer-events:auto;       /* ← ここを none から auto に！ */
}
    .celebration{
      text-align:center; padding:22px 20px; border-radius:22px;
      border:1px solid rgba(255,255,255,.18); background:rgba(20,28,48,.55);
      box-shadow:0 20px 60px rgba(0,0,0,.55); animation: popIn .5s ease-out both .15s;
    }
    .celebration h1{
      font-size:40px; margin:0 0 8px; letter-spacing:1.5px;
      background:linear-gradient(90deg,#fff,#ffd166,#6ef7ff,#ff7ad9,#fff);
      -webkit-background-clip:text; background-clip:text; color:transparent;
      animation: hue 3.5s linear infinite;
      text-shadow:0 6px 24px rgba(255,255,255,.25);
    }
    .celebration .big{ font-size:18px; color:#cfe3ff; margin-bottom:8px }
    .celebration .score{ font-weight:800; font-size:22px; letter-spacing:1px; margin:8px 0 14px }
    .celebration .row{ display:flex; gap:10px; justify-content:center; flex-wrap:wrap }
    .celebration .btn{ min-width:160px; }
    @keyframes hue { from{filter:hue-rotate(0)} to{filter:hue-rotate(360deg)}}
    @keyframes popIn{ 0%{ transform:scale(.85); opacity:0 } 100%{ transform:scale(1); opacity:1 } }
    .pulse-ring{ position:absolute; inset:0; pointer-events:none; z-index:7; display:none }
    .pulse-ring::before, .pulse-ring::after{
      content:""; position:absolute; left:50%; top:55%; width:20vmax; height:20vmax;
      border-radius:50%; transform:translate(-50%,-50%); border:2px solid rgba(255,255,255,.18);
      animation: ring 2.2s ease-out infinite;
    }
    .pulse-ring::after{ animation-delay:1.1s }
    @keyframes ring{ 0%{ opacity:.6; transform:translate(-50%,-50%) scale(.7) } 100%{ opacity:0; transform:translate(-50%,-50%) scale(2.2) } }
  </style>
</head>
<body>
  <div class="wrap">
    <canvas id="game"></canvas>
    <canvas id="celebrateFx"></canvas> <!-- 祝福演出用 -->

    <div class="hud" aria-live="polite">
      <div style="display:flex;gap:8px">
        <div class="badge" id="score">SCORE: 0</div>
        <div class="badge" id="lives">LIVES: 3</div>
        <div class="badge" id="level">LEVEL: 1</div>
        <div class="badge" id="miss" style="display:none">MISS: 0/3</div>
      </div>
      <div style="display:flex;gap:8px;align-items:center">
        <div class="badge" id="status">READY</div>
        <button class="badge" id="muteBtn" aria-pressed="false" style="cursor:pointer">🔊 ON</button>
      </div>
    </div>

    <div class="overlay" id="start">
      <div class="panel">
        <h1>音感＆読譜シューティング</h1>
        <div class="keys">
          <span>← →：移動</span>
          <span>Space：ショット</span>
          <span>P：一時停止 / R：再開</span>
        </div>
        <button class="btn" id="startBtn">ゲーム開始</button>
        <p class="muted" style="margin-top:10px">モバイルは画面下の◀ ● ▶ボタンでも操作できます。</p>
      </div>
    </div>

    <div class="overlay" id="levelup" style="display:none">
      <div class="panel">
        <h1>LEVEL UP!</h1>
        <p class="desc">Lv.1 クリア → Lv.2（楽譜モード）解放</p>
        <button class="btn" id="continueBtn" data-next="2">つづける</button>
      </div>
    </div>

    <div class="overlay" id="quiz" style="display:none">
      <div class="panel">
        <h1 id="quizTitle">この音は？</h1>
        <p class="desc" id="quizHint">音を聴いて（Lv.3）／音を聴いて（Lv.4）楽譜カード3つから選ぼう。</p>
        <div id="quizCards" class="quiz-cards" style="display:none">
          <canvas class="quiz-card" id="quizCard1" width="200" height="120"></canvas>
          <canvas class="quiz-card" id="quizCard2" width="200" height="120"></canvas>
          <canvas class="quiz-card" id="quizCard3" width="200" height="120"></canvas>
        </div>
        <div id="quizTextChoices" class="quiz-choices" style="display:none">
          <button class="btn" id="quizC1">—</button>
          <button class="btn" id="quizC2">—</button>
          <button class="btn" id="quizC3">—</button>
        </div>
      </div>
    </div>

    <!-- 祝福の光輪＆メッセージ -->
    <div class="pulse-ring" id="pulseRing"></div>
    <div id="finaleGlow">
      <div class="celebration">
        <h1>🎉 CONGRATS! 🎉</h1>
        <div class="big">Lv.4クリア！見事な読譜＆音感でした。</div>
        <div class="score"><span id="finaleScore">Total Score: 0</span> ・ <span id="bestScore">Best: 0</span></div>
        <div class="row" style="margin-top:10px">
          <button class="btn" id="againBtn">最初から</button>
          <button class="btn" id="encoreBtn">🔁 ファンファーレもう一回</button>
        </div>
      </div>
    </div>

    <div class="overlay" id="gameover" style="display:none">
      <div class="panel">
        <h1>GAME OVER</h1>
        <p class="desc" id="final">Your Score: 0</p>
        <button class="btn" id="restartBtn">もう一度</button>
      </div>
    </div>

    <div class="mobile-controls" id="mobile">
      <button class="mc-btn" id="leftBtn" aria-label="左へ">◀</button>
      <button class="mc-btn" id="fireBtn" aria-label="ショット">●</button>
      <button class="mc-btn" id="rightBtn" aria-label="右へ">▶</button>
    </div>
  </div>

  <script>
  // ====== Utility ======
  const clamp = (v, min, max) => Math.max(min, Math.min(max, v));
  const rand = (a, b) => Math.random() * (b - a) + a;
  const hitRect = (a,b)=> (Math.abs(a.x-b.x)*2 < (a.w+b.w)) && (Math.abs(a.y-b.y)*2 < (a.h+b.h));

  // ====== Canvas & DPR ======
  const canvas = document.getElementById('game');
  const ctx = canvas.getContext('2d');
  const fxCanvas = document.getElementById('celebrateFx');
  const fx = fxCanvas.getContext('2d');

  const dpr = Math.max(1, Math.min(2, window.devicePixelRatio || 1));
  let W=0,H=0;
  function resize(){
    const {clientWidth:w, clientHeight:h}=canvas;
    W=Math.floor(w*dpr); H=Math.floor(h*dpr);
    canvas.width=W; canvas.height=H; ctx.setTransform(dpr,0,0,dpr,0,0);
    fxCanvas.width=W; fxCanvas.height=H; fx.setTransform(dpr,0,0,dpr,0,0);
  }
  new ResizeObserver(resize).observe(canvas);

  // ====== Game State ======
  const state = { playing:false, paused:false, score:0, lives:3, time:0, invincible:0, level:1 };
  const LEVEL1_GOAL=1000;
  const LEVEL2_GOAL=2000;
  const LEVEL3_GOAL=3500;
  const LEVEL4_GOAL=5000;

  // ====== Audio ======
  let ac, masterGain, sfxGain, bgGain, bgOsc1, bgOsc2, lfo, lfoGain;
  function initAudio(){
    if(ac){ ac.resume(); setBgmMuted(false); return; }
    ac=new (window.AudioContext||window.webkitAudioContext)();
    masterGain=ac.createGain(); masterGain.gain.value=0.8; masterGain.connect(ac.destination);
    sfxGain=ac.createGain(); sfxGain.gain.value=0.6; sfxGain.connect(masterGain);
    bgGain=ac.createGain(); bgGain.gain.value=0.05; bgGain.connect(masterGain);
    bgOsc1=ac.createOscillator(); bgOsc2=ac.createOscillator();
    bgOsc1.type='sine'; bgOsc2.type='sine';
    bgOsc1.frequency.value=196; bgOsc2.frequency.value=246.94;
    lfo=ac.createOscillator(); lfo.frequency.value=0.4;
    lfoGain=ac.createGain(); lfoGain.gain.value=0.03;
    lfo.connect(lfoGain); lfoGain.connect(bgGain.gain);
    bgOsc1.connect(bgGain); bgOsc2.connect(bgGain);
    bgOsc1.start(); bgOsc2.start(); lfo.start();
  }
  function setBgmMuted(m){ if(!ac) return; bgGain.gain.setTargetAtTime(m?0:0.05, ac.currentTime, 0.15); }

  const SFX={
    tone({type='square', f0=440, f1=null, dur=0.12, vol=0.5}){ if(!ac) return;
      const o=ac.createOscillator(); const g=ac.createGain();
      o.type=type; o.connect(g); g.connect(sfxGain);
      const t=ac.currentTime;
      g.gain.setValueAtTime(0.0001,t);
      if(f1!=null){ o.frequency.setValueAtTime(f0,t); o.frequency.exponentialRampToValueAtTime(f1,t+dur);}
      else { o.frequency.setValueAtTime(f0,t);}
      g.gain.linearRampToValueAtTime(vol,t+0.02);
      g.gain.exponentialRampToValueAtTime(0.0001,t+dur);
      o.start(t); o.stop(t+dur+0.03);
    },
    shoot(){ SFX.tone({type:'square', f0:520, f1:880, dur:0.08, vol:0.25}); },
    explode(){ SFX.tone({type:'sawtooth', f0:230, f1:40, dur:0.42, vol:0.45}); },
    hit(){ SFX.tone({type:'triangle', f0:700, f1:190, dur:0.24, vol:0.32}); },
    gameOver(){ if(!ac) return; const notes=[392,330,262]; let t=ac.currentTime;
      for(const f of notes){
        const o=ac.createOscillator(), g=ac.createGain(); o.type='sine'; o.frequency.value=f; o.connect(g); g.connect(sfxGain);
        g.gain.setValueAtTime(0.0001,t); g.gain.linearRampToValueAtTime(0.35,t+0.02); g.gain.exponentialRampToValueAtTime(0.0001,t+0.32);
        o.start(t); o.stop(t+0.34); t+=0.28;
      }
    },
  };

  // 追加：グランド・ファンファーレ
  SFX.grandFanfare=function(){
    if(!ac) return;
    const t0=ac.currentTime;
    const mk = (freq,type='square',t=t0,len=0.28,vol=0.6)=>{
      const o=ac.createOscillator(), g=ac.createGain();
      o.type=type; o.frequency.value=freq; o.connect(g); g.connect(sfxGain);
      g.gain.setValueAtTime(0.0001,t);
      g.gain.linearRampToValueAtTime(vol,t+0.02);
      g.gain.exponentialRampToValueAtTime(0.0001,t+len);
      o.start(t); o.stop(t+len+0.05);
    };
    // ティンパニ風ノイズ
    const drum=(t, len=0.5)=>{
      const n=ac.createBufferSource();
      const buf=ac.createBuffer(1, ac.sampleRate*len, ac.sampleRate);
      const data=buf.getChannelData(0);
      for(let i=0;i<data.length;i++){ data[i]=(Math.random()*2-1)*Math.pow(1-i/data.length,2.0); }
      n.buffer=buf;
      const g=ac.createGain(); g.gain.setValueAtTime(0.6,t); g.gain.exponentialRampToValueAtTime(0.0001,t+len);
      n.connect(g); g.connect(sfxGain); n.start(t);
    };
    // 簡易ディレイ
    const delay=ac.createDelay(0.5); delay.delayTime.value=0.22;
    const fb=ac.createGain(); fb.gain.value=0.35;
    const tap=ac.createGain(); tap.gain.value=0.8;
    tap.connect(delay); delay.connect(fb); fb.connect(delay); delay.connect(sfxGain);

    // メロディ＆ファンファーレ（C→G→C）
    const Cmaj=[261.63,329.63,392.00,523.25];
    const Gmaj=[196.00,246.94,392.00,493.88];
    let t=t0;
    // アルペジオ上昇
    Cmaj.forEach((f,i)=>mk(f,'square',t+i*0.12,0.25,0.65));
    drum(t0); drum(t0+0.6);
    // 和音ヒット + ディレイへも流す
    const chordHit=(freqs, tt)=>{
      freqs.forEach(f=>{
        const o=ac.createOscillator(), g=ac.createGain();
        o.type='triangle'; o.frequency.value=f; o.connect(g); g.connect(sfxGain); g.connect(tap);
        g.gain.setValueAtTime(0.0001,tt);
        g.gain.linearRampToValueAtTime(0.7,tt+0.03);
        g.gain.exponentialRampToValueAtTime(0.0001,tt+1.4);
        o.start(tt); o.stop(tt+1.45);
      });
    };
    t=t0+0.6; chordHit(Cmaj,t);
    // ブリッジ
    Gmaj.forEach((f,i)=>mk(f,'sawtooth',t+0.5+i*0.1,0.18,0.5));
    // ラスト和音
    chordHit([261.63,329.63,392.00,523.25,659.25], t+1.1);
  };

  // 音階など
  const SCALE=[261.63,293.66,329.63,349.23,392.00,440.00,493.88,523.25];
  const NOTE_LABELS=['ド','レ','ミ','ファ','ソ','ラ','シ','ド'];
  SFX.scaleNote=function(){ if(!ac) return -1;
    const idx=(Math.random()*SCALE.length)|0;
    const o=ac.createOscillator(); const g=ac.createGain(); o.type='sine'; o.frequency.value=SCALE[idx]; o.connect(g); g.connect(sfxGain);
    const t=ac.currentTime; g.gain.setValueAtTime(0.0001,t); g.gain.linearRampToValueAtTime(0.95,t+0.02); g.gain.exponentialRampToValueAtTime(0.0001,t+1.0);
    o.start(t); o.stop(t+1.05); return idx;
  };
  SFX.playIdx=function(idx, dur=1.0, vol=0.95){ if(!ac) return;
    const f=SCALE[idx]; const o=ac.createOscillator(); const g=ac.createGain();
    o.type='sine'; o.frequency.value=f; o.connect(g); g.connect(sfxGain);
    const t=ac.currentTime; g.gain.setValueAtTime(0.0001,t); g.gain.linearRampToValueAtTime(vol,t+0.02); g.gain.exponentialRampToValueAtTime(0.0001,t+dur);
    o.start(t); o.stop(t+dur+0.05);
  };

  // Mute button
  const muteBtn=document.getElementById('muteBtn'); let hardMute=false;
  function updateMuteBtn(){ muteBtn.textContent= hardMute?'🔇 MUTE':'🔊 ON'; }
  muteBtn.addEventListener('click',()=>{ if(!ac) initAudio(); hardMute=!hardMute; if(ac){ masterGain.gain.setTargetAtTime(hardMute?0:0.8, ac.currentTime, 0.01);} updateMuteBtn(); });
  updateMuteBtn();

  // ====== Entities ======
  const player={x:160,y:0,w:28,h:28,speed:320,color:'#a7ff83'};
  const bullets=[], enemies=[], sparks=[], stars=[], popups=[];
  let levelupShown=false, finaleShown=false, quizActive=false, quizAnswer=-1, quizMode='audio', quizMiss=0;

  function initStars(){
    stars.length=0;
    const n=Math.floor((canvas.clientWidth*canvas.clientHeight)/1500);
    for(let i=0;i<n;i++){
      stars.push({x:rand(0,canvas.clientWidth), y:rand(0,canvas.clientHeight), s:rand(0.4,2.2), v:rand(20,80)});
    }
  }

  function reset(){
    state.playing=true; state.paused=false; state.score=0; state.lives=3; state.time=0; state.invincible=0; state.level=1;
    levelupShown=false; finaleShown=false; quizActive=false; quizAnswer=-1; quizMode='audio'; quizMiss=0;
    bullets.length=0; enemies.length=0; sparks.length=0; popups.length=0;
    player.x=canvas.clientWidth/2; player.y=canvas.clientHeight-60;
    enemyTimer=0; enemyInterval=0.9;
    document.getElementById('status').textContent='PLAY';
    document.getElementById('score').textContent='SCORE: 0';
    document.getElementById('lives').textContent='LIVES: 3';
    document.getElementById('level').textContent='LEVEL: 1';
    const m=document.getElementById('miss'); m.textContent='MISS: 0/3'; m.style.display='none';
    canvas.style.pointerEvents='auto';
    // 祝福表示を消す
    stopCelebration();
  }

  // ====== Controls ======
  const keys={left:false,right:false,fire:false};
  function onKey(e,v){
    if(e.code==='ArrowLeft'){keys.left=v; e.preventDefault();}
    if(e.code==='ArrowRight'){keys.right=v; e.preventDefault(); }
    if(e.code==='Space'){keys.fire=v; e.preventDefault();}
    if(v&&e.code==='KeyP'){state.paused=!state.paused; document.getElementById('status').textContent=state.paused?'PAUSE':'PLAY'; setBgmMuted(state.paused);}
    if(v&&e.code==='KeyR'){state.paused=false; document.getElementById('status').textContent='PLAY'; setBgmMuted(false);}
  }
  addEventListener('keydown',e=>onKey(e,true));
  addEventListener('keyup',e=>onKey(e,false));

  function hold(btn,on,off){
    const start=e=>{e.preventDefault(); on();};
    const end=e=>{e.preventDefault(); off();};
    ['pointerdown','touchstart','mousedown'].forEach(ev=>btn.addEventListener(ev,start));
    ['pointerup','pointercancel','touchend','mouseup','mouseleave'].forEach(ev=>btn.addEventListener(ev,end));
  }
  hold(document.getElementById('leftBtn'),()=>keys.left=true,()=>keys.left=false);
  hold(document.getElementById('rightBtn'),()=>keys.right=true,()=>keys.right=false);
  hold(document.getElementById('fireBtn'),()=>keys.fire=true,()=>keys.fire=false);

  // ====== Shooting & Enemies ======
  let fireCd=0;
  function shoot(){ bullets.push({x:player.x,y:player.y-16,w:6,h:14,v:600}); }

  let enemyTimer=0, enemyInterval=0.9;
  function spawnEnemy(){
    const size=rand(22,36);
    const x=clamp(rand(size,canvas.clientWidth-size),size,canvas.clientWidth-size);
    const y=-size;
    const speed=rand(80,160)+Math.min(180,state.time*5);
    enemies.push({x,y,w:size,h:size,v:speed});
  }
  function boom(x,y,n=14){ for(let i=0;i<n;i++){ sparks.push({x,y, vx:rand(-180,180), vy:rand(-220,-40), g:520, life:rand(.4,.9)});} }

  // ====== Music Notation Helpers ======
  const STAFF={sp:10};
  const STAFF_POS=[-2,-1,0,1,2,3,4,5]; // C4..C5
  function drawStaff(c2,x,y,posIndex,width=140){
    const sp=STAFF.sp, step=sp/2;
    const yTop=y + (posIndex-8)*step;
    c2.save();
    c2.strokeStyle='rgba(255,255,255,0.85)';
    c2.lineWidth=1.2;
    for(let i=0;i<5;i++){
      const ly=yTop+i*sp;
      c2.beginPath(); c2.moveTo(x-width/2,ly); c2.lineTo(x+width/2,ly); c2.stroke();
    }
    const ledgerYs=[];
    if(posIndex>=10) ledgerYs.push(y+(posIndex-10)*step);
    if(posIndex>=12) ledgerYs.push(y+(posIndex-12)*step);
    if(posIndex<=-2) ledgerYs.push(y+(posIndex+2)*step);
    if(posIndex<=-4) ledgerYs.push(y+(posIndex+4)*step);
    for(const ly of ledgerYs){ c2.beginPath(); c2.moveTo(x-22,ly); c2.lineTo(x+22,ly); c2.stroke(); }
    c2.restore();
  }
  function drawStaffNote(c2,x,y,posIndex,color='#6ef7ff',alpha=1){
    c2.save(); c2.shadowColor=color; c2.shadowBlur=28; c2.globalAlpha=alpha;
    drawStaff(c2,x,y,posIndex,140);
    c2.fillStyle='#ffffff';
    c2.beginPath(); c2.ellipse(x,y,9,6.5,-0.5,0,Math.PI*2); c2.fill();
    const stemUp=(posIndex<=4);
    if(stemUp){ c2.fillRect(x+7,y-20,2.5,20);} else { c2.fillRect(x-9,y,2.5,20); }
    c2.restore();
  }

  // ====== Loop ======
  let last=0;
  function loop(t){
    requestAnimationFrame(loop);
    if(!state.playing || state.paused || levelupShown || quizActive) return;

    const now=t/1000; const dt=Math.min(0.033, now-last||0); last=now; state.time+=dt;
    enemyInterval=Math.max(0.28, 0.9 - state.time*0.02);

    // Clear & BG
    ctx.clearRect(0,0,canvas.clientWidth,canvas.clientHeight);
    ctx.save();
    ctx.globalAlpha=.9; ctx.fillStyle='#0b1020'; ctx.fillRect(0,0,canvas.clientWidth,canvas.clientHeight);
    ctx.globalAlpha=1; ctx.fillStyle='#b3c8ff';
    for(const s of stars){ s.y += (s.v + state.time*8)*dt; if(s.y>canvas.clientHeight){ s.y=-2; s.x=rand(0,canvas.clientWidth);} ctx.fillRect(s.x,s.y,s.s,s.s);}
    ctx.restore();

    // Player
    if(keys.left) player.x -= player.speed*dt; if(keys.right) player.x += player.speed*dt;
    player.x=clamp(player.x,18,canvas.clientWidth-18);
    drawShip(player);

    // Bullets
    fireCd -= dt; if(keys.fire && fireCd<=0){ shoot(); if(ac) SFX.shoot(); fireCd=0.16; }
    ctx.fillStyle='#66e2ff'; ctx.shadowColor='#66e2ff'; ctx.shadowBlur=12;
    for(let i=bullets.length-1;i>=0;i--){
      const b=bullets[i]; b.y -= b.v*dt; ctx.fillRect(b.x-2,b.y-b.h/2,b.w,b.h); if(b.y<-20) bullets.splice(i,1);
    }
    ctx.shadowBlur=0;

    // Enemies
    enemyTimer -= dt; if(enemyTimer<=0){ spawnEnemy(); enemyTimer=enemyInterval; }
    for(let i=enemies.length-1;i>=0;i--){
      const e=enemies[i]; e.y += e.v*dt; drawEnemy(e);
      if(e.y - e.h/2 > canvas.clientHeight){ enemies.splice(i,1); continue; }

      // Bullet collision
      for(let j=bullets.length-1;j>=0;j--){
        const b=bullets[j];
        if(hitRect({x:e.x,y:e.y,w:e.w,h:e.h},{x:b.x,y:b.y,w:b.w,h:b.h})){
          bullets.splice(j,1); enemies.splice(i,1);
          state.score+=100; document.getElementById('score').textContent=`SCORE: ${state.score}`;
          const ex=e.x, ey=e.y; boom(ex,ey);

          // 音／問題の決定
          let idx=-1;
          if(ac && state.level!==4) idx=SFX.scaleNote(); // Lv.4はクイズ開始時に鳴らす
          const noteIdx = (idx<0? ((Math.random()*SCALE.length)|0) : idx);

          if(state.level===1){
            const lbl=['ド','レ','ミ','ファ','ソ','ラ','シ','ド'][noteIdx];
            popups.push({x:ex+rand(-12,12), y:ey+rand(-12,12), text:lbl, start:now+0.6, end:now+1.6, color:'#6ef7ff', type:'text'});
          }
          else if(state.level===2){
            popups.push({x:ex+rand(-12,12), y:ey+rand(-12,12), noteIdx, start:now+0.6, end:now+1.6, color:'#6ef7ff', type:'note'});
          }
          else if(state.level===3){
            startQuiz(noteIdx,'audio'); return;
          }
          else if(state.level===4){
            startQuiz(noteIdx,'cards'); return; // Lv.4は楽譜カード3枚
          }

          if(state.level===1 && !levelupShown && state.score>=LEVEL1_GOAL){ levelUp(2); return; }
          if(state.level===2 && state.score>=LEVEL2_GOAL){ levelUp(3); return; }
          if(state.level===4 && !finaleShown && state.score>=LEVEL4_GOAL){ finale(); return; }
          break;
        }
      }

      // Player collision
      if(state.invincible<=0 && hitRect({x:e.x,y:e.y,w:e.w,h:e.h}, player)){
        enemies.splice(i,1); state.lives-=1; state.invincible=1.2; document.getElementById('lives').textContent=`LIVES: ${state.lives}`;
        boom(player.x,player.y,22); if(ac) SFX.hit(); if(state.lives<=0){ return gameOver(); }
      }
    }

    // Sparks
    ctx.fillStyle='#ffd166';
    for(let i=sparks.length-1;i>=0;i--){
      const s=sparks[i]; s.vx*=(1-1.6*dt); s.vy+=s.g*dt; s.x+=s.vx*dt/2; s.y+=s.vy*dt/2; s.life-=dt;
      ctx.globalAlpha=Math.max(0,s.life); ctx.fillRect(s.x-1,s.y-1,2,2); ctx.globalAlpha=1;
      if(s.life<=0) sparks.splice(i,1);
    }

    // Popups
    ctx.save();
    for(let i=popups.length-1;i>=0;i--){
      const p=popups[i];
      const now2=now;
      if(now2>=p.start && now2<=p.end){
        const tt=(now2-p.start)/(p.end-p.start);
        const lift=-24-tt*12; const nx=p.x, ny=p.y+lift;
        if(p.type==='text'){
          ctx.font='bold 30px system-ui, -apple-system, Segoe UI, Meiryo, sans-serif';
          ctx.textAlign='center'; ctx.textBaseline='middle';
          ctx.shadowColor=p.color||'#6ef7ff'; ctx.shadowBlur=24; ctx.fillStyle='#ffffff'; ctx.globalAlpha=0.95-tt*0.2; ctx.fillText(p.text,nx,ny); ctx.globalAlpha=1;
        } else {
          const posIndex=(p.noteIdx!=null)? STAFF_POS[p.noteIdx] : 0;
          const alpha=0.95-tt*0.25; drawStaffNote(ctx,nx,ny,posIndex,p.color||'#6ef7ff',alpha);
        }
      }
      if(now2>p.end){ popups.splice(i,1); }
    }
    ctx.restore();

    if(state.invincible>0){ state.invincible-=dt; if(Math.floor(state.invincible*10)%2===0){ ctx.save(); ctx.globalAlpha=.4; drawShip(player); ctx.restore(); } }
  }

  function drawShip(p){
    ctx.save(); ctx.translate(p.x,p.y);
    ctx.shadowColor='#58ffd5'; ctx.shadowBlur=14; ctx.fillStyle='#58ffd5';
    ctx.beginPath(); ctx.moveTo(0,-16); ctx.lineTo(12,12); ctx.lineTo(0,6); ctx.lineTo(-12,12); ctx.closePath(); ctx.fill();
    ctx.restore();
  }

  function drawEnemy(e){
    ctx.save(); ctx.translate(e.x,e.y);
    ctx.shadowColor='#ff9aa2'; ctx.shadowBlur=10; ctx.fillStyle='#ff9aa2';
    ctx.beginPath(); ctx.arc(0,0,e.w/2,0,Math.PI*2); ctx.fill();
    ctx.restore();
  }

  function gameOver(){
    state.playing=false; document.getElementById('final').textContent=`Your Score: ${state.score}`;
    document.getElementById('gameover').style.display='grid';
    document.getElementById('status').textContent='GAME OVER'; if(ac) SFX.gameOver(); setBgmMuted(true);
    canvas.style.pointerEvents='none';
  }

  function levelUp(nextLevel=2){
    state.paused=true; levelupShown=true; document.getElementById('status').textContent='LEVEL UP';
    const p=document.querySelector('#levelup .desc');
    p.textContent = nextLevel===2 ? 'Lv.1 クリア → Lv.2（楽譜モード）解放'
                 : (nextLevel===3 ? 'Lv.2 クリア → Lv.3（音当てクイズ）解放'
                 : 'Lv.3 クリア → Lv.4（楽譜カードクイズ）解放');
    document.getElementById('levelup').style.display='grid';
    document.getElementById('continueBtn').dataset.next=String(nextLevel);
    canvas.style.pointerEvents='none';
  }

  // === 祝福演出 ===
  let confetti=[], fireworks=[], fxLast=0, fxReq=null;
  function spawnConfettiBurst(x, y, n=80){
    for(let i=0;i<n;i++){
      confetti.push({
        x, y,
        vx: rand(-220,220), vy: rand(-420,-120),
        g: 900,
        life: rand(1.0, 1.8),
        w: rand(4,8), h: rand(8,14),
        rot: rand(0,Math.PI*2), vr: rand(-8,8),
        hue: (Math.random()*360)|0
      });
    }
  }
  function spawnFirework(x, y, n=90){
    for(let i=0;i<n;i++){
      const sp=rand(140,280);
      const a=rand(0,Math.PI*2);
      fireworks.push({
        x, y,
        vx: Math.cos(a)*sp, vy: Math.sin(a)*sp,
        g: 400, life: rand(0.9,1.4),
        r: rand(1.5,2.8),
        hue: (Math.random()*360)|0
      });
    }
  }
  function runCelebration(){
    fxCanvas.style.display='block';
    document.getElementById('pulseRing').style.display='block';
    const step=(t)=>{
      if(!fxLast) fxLast=t;
      const dt=Math.min(0.033, (t-fxLast)/1000); fxLast=t;
      fx.clearRect(0,0,fxCanvas.clientWidth,fxCanvas.clientHeight);

      // confetti
      for(let i=confetti.length-1;i>=0;i--){
        const p=confetti[i];
        p.vx *= (1-0.4*dt);
        p.vy += p.g*dt;
        p.x += p.vx*dt;
        p.y += p.vy*dt;
        p.rot += p.vr*dt;
        p.life -= dt;
        fx.save();
        fx.translate(p.x, p.y);
        fx.rotate(p.rot);
        fx.fillStyle=`hsl(${p.hue}, 90%, 60%)`;
        fx.fillRect(-p.w/2,-p.h/2,p.w,p.h);
        fx.restore();
        if(p.life<=0 || p.y>fxCanvas.clientHeight+40) confetti.splice(i,1);
      }

      // fireworks
      fx.globalCompositeOperation='lighter';
      for(let i=fireworks.length-1;i>=0;i--){
        const f=fireworks[i];
        f.vx *= (1-0.1*dt);
        f.vy += f.g*dt;
        f.x += f.vx*dt; f.y += f.vy*dt;
        f.life -= dt;
        fx.beginPath();
        fx.fillStyle=`hsla(${f.hue},100%,65%,${Math.max(0,f.life)})`;
        fx.arc(f.x,f.y, f.r, 0, Math.PI*2); fx.fill();
        if(f.life<=0) fireworks.splice(i,1);
      }
      fx.globalCompositeOperation='source-over';

      if(confetti.length>0 || fireworks.length>0) {
        fxReq=requestAnimationFrame(step);
      } else {
        stopCelebration(); // 自然停止
      }
    };
    fxReq=requestAnimationFrame(step);
  }
  function stopCelebration(){
    if(fxReq){ cancelAnimationFrame(fxReq); fxReq=null; }
    fxCanvas.style.display='none';
    document.getElementById('pulseRing').style.display='none';
    confetti.length=0; fireworks.length=0; fxLast=0;
  }
  function blastShow(){
    // 画面中央と両サイドで派手に
    const w=fxCanvas.clientWidth, h=fxCanvas.clientHeight;
    spawnConfettiBurst(w*0.5, h*0.25, 120);
    spawnConfettiBurst(w*0.2, h*0.3, 80);
    spawnConfettiBurst(w*0.8, h*0.3, 80);
    spawnFirework(w*0.5, h*0.45, 120);
    spawnFirework(w*0.25, h*0.55, 90);
    spawnFirework(w*0.75, h*0.55, 90);
    runCelebration();
  }

  function finale(){
    state.playing=false; state.paused=true; finaleShown=true;
    document.getElementById('status').textContent='FINALE';

    // スコア＆ベスト
    const finalText = `Total Score: ${state.score}`;
    document.getElementById('finaleScore').textContent = finalText;
    const best = Math.max(state.score, +(localStorage.getItem('bestScore')||0));
    localStorage.setItem('bestScore', best);
    document.getElementById('bestScore').textContent = `Best: ${best}`;

    // 祝福演出開始
    setBgmMuted(true);
    if(ac) SFX.grandFanfare();
    blastShow();
    document.getElementById('finaleGlow').style.display='grid';
    canvas.style.pointerEvents='none';
  }

  // ====== Quiz (Lv.3 & Lv.4) ======
  let lastAnswerTs = 0;

  function showQuizUI(which){
    document.getElementById('quiz').style.display='grid';
    const missBadge=document.getElementById('miss');
    if(which==='audio'){ // Lv.3
      document.getElementById('quizTextChoices').style.display='';
      document.getElementById('quizCards').style.display='none';
      missBadge.style.display='';
    }else{ // 'cards' Lv.4
      document.getElementById('quizTextChoices').style.display='none';
      document.getElementById('quizCards').style.display='';
      missBadge.style.display='none';
    }
  }

  function startQuiz(correctIdx, mode='audio'){
    if(quizActive) return;
    quizMode = mode;
    quizActive=true; quizAnswer=correctIdx; state.paused=true; document.getElementById('status').textContent='QUIZ';
    canvas.style.pointerEvents='none';

    // 選択肢
    const pool=[...Array(SCALE.length).keys()].filter(i=>i!==correctIdx);
    const wrong1=pool.splice((Math.random()*pool.length)|0,1)[0];
    const wrong2=pool.splice((Math.random()*pool.length)|0,1)[0];
    const choices=[correctIdx,wrong1,wrong2].sort(()=>Math.random()-0.5);

    if(mode==='audio'){ // Lv.3: テキスト三択
      const ids=['quizC1','quizC2','quizC3'];
      const btnClass=(idx)=> idx===7 ? 'high' : (idx===0 ? 'low' : '');
      choices.forEach((idx,i)=>{
        const b=document.getElementById(ids[i]);
        b.textContent = (idx===7? 'ド↑' : NOTE_LABELS[idx]);
        b.dataset.idx=String(idx);
        b.classList.remove('high','low');
        const c=btnClass(idx); if(c) b.classList.add(c);
      });
      showQuizUI('audio');
      if(ac) SFX.playIdx(correctIdx);
    }else{ // Lv.4: 楽譜カード三択
      const cardIds=['quizCard1','quizCard2','quizCard3'];
      cardIds.forEach((id,i)=>{
        const cvs=document.getElementById(id);
        const c2=cvs.getContext('2d');
        c2.clearRect(0,0,cvs.width,cvs.height);
        const x=cvs.width/2, y=cvs.height/2;
        const posIndex=STAFF_POS[choices[i]];
        drawStaffNote(c2,x,y,posIndex,'#6ef7ff',1);
        cvs.dataset.idx=String(choices[i]);
      });
      showQuizUI('cards');
      if(ac) SFX.playIdx(correctIdx);
    }
  }

  function endQuiz(correct){
    document.getElementById('quiz').style.display='none';
    canvas.style.pointerEvents='auto';
    quizActive=false; state.paused=false; document.getElementById('status').textContent='PLAY';

    if(correct){
      state.score+=150; document.getElementById('score').textContent=`SCORE: ${state.score}`;
      if(ac) SFX.tone({type:'square', f0:660, f1:990, dur:0.18, vol:0.35});
   } else {
  // 不正解時の共通ブブー音
  if (ac) SFX.tone({ type: 'sawtooth', f0: 200, f1: 120, dur: 0.25, vol: 0.25 });

  if (quizMode === 'audio') {
    // Lv.3：従来どおりMISSカウント（3回で終了）
    quizMiss = (quizMiss || 0) + 1;
    const m = document.getElementById('miss');
    m.textContent = `MISS: ${quizMiss}/3`;
    if (quizMiss >= 3) { gameOver(); return; }
  } else {
    // Lv.4：ライフを減らす（3→0でゲームオーバー）
    state.lives = Math.max(0, state.lives - 1);
    document.getElementById('lives').textContent = `LIVES: ${state.lives}`;
    // ちょい演出
    const lives = document.getElementById('lives');
    lives.style.transform = 'scale(1.06)';
    lives.style.background = 'rgba(255,107,107,.18)';
    setTimeout(() => {
      lives.style.transform = '';
      lives.style.background = 'rgba(255,255,255,.06)';
    }, 180);

    if (state.lives <= 0) { gameOver(); return; }
  }
}

    if(state.playing && state.level===3 && state.score>=LEVEL3_GOAL){ levelUp(4); return; }
    if(state.playing && state.level===4 && !finaleShown && state.score>=LEVEL4_GOAL){ finale(); return; }
  }

  // Lv.3 ボタン
  ['quizC1','quizC2','quizC3'].forEach(id=>{
    document.getElementById(id).addEventListener('click',(e)=>{
      if(!quizActive) return;
      const now=performance.now(); if(now - lastAnswerTs < 50) return; lastAnswerTs=now;
      const idx=Number(e.currentTarget.dataset.idx||'-1');
      endQuiz(idx===quizAnswer);
    });
  });

  // Lv.4 カード
  ['quizCard1','quizCard2','quizCard3'].forEach(id=>{
    const el=document.getElementById(id);
    const handler=(e)=>{
      if(!quizActive) return;
      const now=performance.now(); if(now - lastAnswerTs < 50) return; lastAnswerTs=now;
      const idx=Number(e.currentTarget.dataset.idx||'-1');
      endQuiz(idx===quizAnswer);
    };
    el.addEventListener('click', handler);
    el.addEventListener('touchend', (e)=>{ e.preventDefault(); handler(e); }, {passive:false});
  });

  // ====== Start / Restart / Buttons ======
  document.getElementById('startBtn').addEventListener('click',()=>{
    document.getElementById('start').style.display='none';
    initAudio(); setBgmMuted(false); reset();
  });
  document.getElementById('restartBtn').addEventListener('click',()=>{
    document.getElementById('gameover').style.display='none';
    initAudio(); setBgmMuted(false); reset();
  });
  document.getElementById('continueBtn').addEventListener('click',(e)=>{
    const next=Number(e.currentTarget.dataset.next||'2');
    document.getElementById('levelup').style.display='none';
    state.level=next; document.getElementById('level').textContent=`LEVEL: ${state.level}`;
    state.paused=false; levelupShown=false; document.getElementById('status').textContent='PLAY'; setBgmMuted(false);
    canvas.style.pointerEvents='auto';
  });
  document.getElementById('againBtn').addEventListener('click',()=>{
    document.getElementById('finaleGlow').style.display='none';
    stopCelebration();
    initAudio(); setBgmMuted(false); reset();
  });
  document.getElementById('encoreBtn').addEventListener('click',()=>{
    if(ac) SFX.grandFanfare();
    blastShow();
  });

  // ====== Misc ======
  document.addEventListener('visibilitychange',()=>{ if(document.hidden){ state.paused=true; document.getElementById('status').textContent='PAUSE'; setBgmMuted(true); } });

  // Boot
  resize(); initStars(); loop(0);
  window.addEventListener('pointerdown',()=>{ if(!ac || ac.state!=='running'){ initAudio(); } }, {once:true});
  window.addEventListener('resize',()=>{ initStars(); });

  </script>
</body>
</html>